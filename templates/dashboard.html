<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - DCAM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                        },
                        secondary: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background-color: #f8fafc;
            color: #1e293b;
        }
        
        .sidebar {
            background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
            color: white;
            min-height: 100vh;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar-item {
            padding: 14px 20px;
            border-radius: 10px;
            margin-bottom: 6px;
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            text-decoration: none;
            color: #cbd5e1;
            font-weight: 500;
        }
        
        .sidebar-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(5px);
        }
        
        .sidebar-item.active {
            background-color: #0ea5e9;
            color: white;
            box-shadow: 0 4px 6px rgba(14, 165, 233, 0.3);
        }
        
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.03);
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0;
        }
        
        .card:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            transform: translateY(-3px);
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(14, 165, 233, 0.3);
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        }
        
        .mobile-menu-btn {
            display: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(14, 165, 233, 0.3);
            border: none;
            cursor: pointer;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(14, 165, 233, 0.4);
        }
        
        .btn-secondary {
            background: white;
            color: #475569;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0;
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            background: #f1f5f9;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .appointment-card {
            border-left: 4px solid #0ea5e9;
            transition: all 0.3s ease;
        }
        
        .appointment-card:hover {
            border-left-color: #3b82f6;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-scheduled {
            background-color: #dbeafe;
            color: #1d4ed8;
        }
        
        .status-completed {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .status-cancelled {
            background-color: #fee2e2;
            color: #b91c1c;
        }
        
        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -100%;
                z-index: 100;
                width: 280px;
                transition: all 0.3s ease;
            }
            
            .sidebar.active {
                left: 0;
            }
            
            .mobile-menu-btn {
                display: block;
            }
            
            .overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 99;
            }
            
            .overlay.active {
                display: block;
            }
        }
    </style>
</head>
<body>
    <div class="flex">
        <!-- Mobile Menu Button -->
        <div class="mobile-menu-btn fixed top-4 left-4 z-50 lg:hidden">
            <button id="menuToggle" class="p-3 bg-primary-600 text-white rounded-xl shadow-lg">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        
        <!-- Overlay for mobile -->
        <div id="overlay" class="overlay"></div>
        
        <!-- Sidebar -->
        <div class="sidebar w-64 min-h-screen p-6 z-40">
            <div class="flex items-center mb-10">
                <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center text-primary-600 font-bold mr-3 shadow-md">
                    <i class="fas fa-hands"></i>
                </div>
                <span class="text-xl font-bold">DCAM</span>
            </div>
            
            <div class="mb-8 p-4 bg-slate-800/50 rounded-xl">
                <div class="flex items-center">
                    <div class="avatar mr-3">
                        <span id="userAvatar">{{ session.first_name[0] }}{{ session.last_name[0] }}</span>
                    </div>
                    <div>
                        <p class="font-semibold" id="userName">{{ session.first_name }} {{ session.last_name }}</p>
                        <p class="text-sm text-slate-300" id="userRole">{{ session.role|title }}</p>
                    </div>
                </div>
            </div>
            
            <nav class="space-y-2">
                <div class="sidebar-item active">
                    <i class="fas fa-tachometer-alt mr-3"></i>
                    <span>Dashboard</span>
                </div>
                <div class="sidebar-item">
                    <i class="fas fa-user mr-3"></i>
                    <span>My Information</span>
                </div>
                <div class="sidebar-item">
                    <i class="fas fa-users mr-3"></i>
                    <span>Patients</span>
                </div>
                <div class="sidebar-item">
                    <i class="fas fa-calendar-alt mr-3"></i>
                    <span>Appointments</span>
                </div>
                <div class="sidebar-item">
                    <i class="fas fa-hand-holding-heart mr-3"></i>
                    <span>Therapy Sessions</span>
                </div>
                <div class="sidebar-item">
                    <i class="fas fa-info-circle mr-3"></i>
                    <span>Healings Info</span>
                </div>
                <div class="sidebar-item">
                    <i class="fas fa-calendar-plus mr-3"></i>
                    <span>Book Appointment</span>
                </div>
                <div class="sidebar-item">
                    <i class="fas fa-cog mr-3"></i>
                    <span>Settings</span>
                </div>
            </nav>
        </div>
        
        <!-- Main Content -->
        <div class="flex-1 p-4 lg:p-8 w-full lg:w-auto">
            <!-- Header -->
            <header class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-slate-800" id="dashboardTitle">
                        {% if session.role == 'doctor' %}Doctor Dashboard
                        {% elif session.role == 'patient' %}Patient Dashboard
                        {% elif session.role == 'receptionist' %}Receptionist Dashboard
                        {% else %}Admin Dashboard{% endif %}
                    </h1>
                    <p class="text-slate-500 mt-1">Welcome back, {{ session.first_name }}! Here's your overview</p>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Search Bar -->
                    <div class="hidden md:block relative">
                        <input type="text" placeholder="Search..." class="pl-10 pr-4 py-2 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent w-64">
                        <i class="fas fa-search absolute left-3 top-3 text-slate-400"></i>
                    </div>
                    
                    <!-- Notifications -->
                    <div class="relative">
                        <button id="notificationBtn" class="p-3 text-slate-600 hover:text-primary-600 transition relative bg-white rounded-xl shadow-sm hover:shadow-md">
                            <i class="fas fa-bell text-xl"></i>
                            <span id="notificationCount" class="notification-badge">3</span>
                        </button>
                        <div id="notificationDropdown" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-xl z-50 border border-slate-200">
                            <div class="p-4 border-b border-slate-100">
                                <h3 class="font-semibold text-slate-800">Notifications</h3>
                            </div>
                            <div id="notificationList" class="max-h-60 overflow-y-auto">
                                <!-- Notifications will be loaded dynamically -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- User Profile -->
                    <div class="flex items-center bg-white rounded-xl p-2 shadow-sm">
                        <div class="avatar mr-3" id="headerAvatar">{{ session.first_name[0] }}{{ session.last_name[0] }}</div>
                        <div class="hidden sm:block">
                            <p class="font-semibold text-slate-800" id="headerName">{{ session.first_name }} {{ session.last_name }}</p>
                            <p class="text-sm text-slate-600" id="headerRole">{{ session.role|title }}</p>
                        </div>
                        <i class="fas fa-chevron-down text-slate-400 ml-2"></i>
                    </div>
                </div>
            </header>
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" id="statsContainer">
                <!-- Stats will be loaded dynamically -->
            </div>
            
            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Appointments Section -->
                <div class="lg:col-span-2">
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold text-slate-800" id="appointmentsTitle">
                                {% if session.role == 'patient' %}My Appointments
                                {% elif session.role == 'doctor' %}Today's Appointments
                                {% else %}Recent Appointments{% endif %}
                            </h2>
                            <div class="flex space-x-3">
                                <button class="btn-secondary" id="filterBtn">
                                    <i class="fas fa-filter mr-2"></i>Filter
                                </button>
                                {% if session.role == 'patient' %}
                                <button class="btn-primary" id="newAppointmentBtn">
                                    <i class="fas fa-plus mr-2"></i>New Appointment
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        <div id="appointmentsContainer">
                            <!-- Appointments will be loaded dynamically -->
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions & Notifications -->
                <div class="space-y-6">
                    <div class="card p-6">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">Quick Actions</h2>
                        <div class="space-y-3">
                            {% if session.role == 'patient' %}
                            <button class="w-full flex items-center p-3 border border-slate-200 rounded-xl hover:bg-slate-50 transition" id="quickAppointmentBtn">
                                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600 mr-3">
                                    <i class="fas fa-plus"></i>
                                </div>
                                <span class="font-medium text-slate-700">New Appointment</span>
                            </button>
                            {% endif %}
                            
                            {% if session.role == 'receptionist' or session.role == 'admin' %}
                            <button class="w-full flex items-center p-3 border border-slate-200 rounded-xl hover:bg-slate-50 transition" id="quickPatientBtn">
                                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center text-green-600 mr-3">
                                    <i class="fas fa-user-plus"></i>
                                </div>
                                <span class="font-medium text-slate-700">Add Patient</span>
                            </button>
                            {% endif %}
                            
                            <button class="w-full flex items-center p-3 border border-slate-200 rounded-xl hover:bg-slate-50 transition" id="quickReportBtn">
                                <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center text-purple-600 mr-3">
                                    <i class="fas fa-file-medical"></i>
                                </div>
                                <span class="font-medium text-slate-700">Create Report</span>
                            </button>
                            
                            <button class="w-full flex items-center p-3 border border-slate-200 rounded-xl hover:bg-slate-50 transition" id="quickScheduleBtn">
                                <div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center text-amber-600 mr-3">
                                    <i class="fas fa-calendar-day"></i>
                                </div>
                                <span class="font-medium text-slate-700">Today's Schedule</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Recent Notifications -->
                    <div class="card p-6">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">Recent Notifications</h2>
                        <div id="recentNotifications">
                            <!-- Notifications will be loaded dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Updated dashboard with real data loading - NO HARDCODED DATA

    // Mobile menu toggle
    const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.getElementById('overlay');
    
    menuToggle.addEventListener('click', () => {
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
    });
    
    overlay.addEventListener('click', () => {
        sidebar.classList.remove('active');
        overlay.classList.remove('active');
    });

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        initializeDashboard();
        setupEventListeners();
        startRealTimeUpdates();
    });

    function initializeDashboard() {
        updateUserInfo();
        loadRealStats();
        loadRealAppointments();
        loadRealNotifications();
    }

    function setupEventListeners() {
        // Notification dropdown
        document.getElementById('notificationBtn').addEventListener('click', function(e) {
            e.stopPropagation();
            const dropdown = document.getElementById('notificationDropdown');
            dropdown.classList.toggle('hidden');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function() {
            document.getElementById('notificationDropdown').classList.add('hidden');
        });

        // Sidebar navigation
        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.sidebar-item').forEach(i => {
                    i.classList.remove('active');
                });
                this.classList.add('active');
                
                // Close mobile menu if open
                if (window.innerWidth < 768) {
                    sidebar.classList.remove('active');
                    overlay.classList.remove('active');
                }
            });
        });

        // Quick action buttons
        document.getElementById('newAppointmentBtn')?.addEventListener('click', createNewAppointment);
        document.getElementById('quickAppointmentBtn')?.addEventListener('click', createNewAppointment);
        document.getElementById('quickPatientBtn')?.addEventListener('click', addNewPatient);
        document.getElementById('quickReportBtn')?.addEventListener('click', createReport);
        document.getElementById('quickScheduleBtn')?.addEventListener('click', showTodaysSchedule);
        document.getElementById('filterBtn')?.addEventListener('click', toggleFilter);
    }

    function updateUserInfo() {
        // User info is already in the template from server-side rendering
        const userName = document.getElementById('headerName').textContent;
        const userRole = document.getElementById('headerRole').textContent;
        
        // Update dashboard title based on role
        const dashboardTitle = document.getElementById('dashboardTitle');
        if (userRole.toLowerCase() === 'doctor') {
            dashboardTitle.textContent = 'Doctor Dashboard';
        } else if (userRole.toLowerCase() === 'patient') {
            dashboardTitle.textContent = 'Patient Dashboard';
        } else if (userRole.toLowerCase() === 'receptionist') {
            dashboardTitle.textContent = 'Receptionist Dashboard';
        } else {
            dashboardTitle.textContent = 'Admin Dashboard';
        }
    }

    // New function to load real stats from API
    function loadRealStats() {
        fetch('/api/dashboard-stats')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load stats');
                }
                return response.json();
            })
            .then(stats => {
                updateStats(stats);
            })
            .catch(error => {
                console.error('Error loading stats:', error);
                updateStats({});
            });
    }

    // New function to load real appointments from API
    function loadRealAppointments() {
        fetch('/api/appointments')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load appointments');
                }
                return response.json();
            })
            .then(appointments => {
                updateAppointments(appointments);
            })
            .catch(error => {
                console.error('Error loading appointments:', error);
                updateAppointments([]);
            });
    }

    // New function to load real notifications from API
    function loadRealNotifications() {
        fetch('/api/notifications')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load notifications');
                }
                return response.json();
            })
            .then(notifications => {
                updateNotifications(notifications);
            })
            .catch(error => {
                console.error('Error loading notifications:', error);
                updateNotifications([]);
            });
    }

    function updateStats(stats) {
        const container = document.getElementById('statsContainer');
        
        // Default values if stats are empty
        const defaultStats = {
            todaysAppointments: 0,
            totalPatients: 0,
            completedSessions: 0,
            monthlyRevenue: 0,
            totalAppointments: 0,
            todayAppointments: 0,
            upcomingAppointments: 0,
            pendingAppointments: 0,
            totalUsers: 0,
            totalDoctors: 0,
            pendingRegistrations: 0
        };
        
        const actualStats = { ...defaultStats, ...stats };
        
        container.innerHTML = `
            <div class="card p-6">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-slate-500">Today's Appointments</p>
                        <h3 class="text-2xl font-bold mt-2 text-slate-800">${actualStats.todaysAppointments || actualStats.todayAppointments || 0}</h3>
                        <p class="text-sm text-green-500 mt-1">Real-time data</p>
                    </div>
                    <div class="p-3 bg-blue-100 rounded-xl">
                        <i class="fas fa-calendar-check text-blue-600 text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="card p-6">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-slate-500">Patients</p>
                        <h3 class="text-2xl font-bold mt-2 text-slate-800">${actualStats.totalPatients || 0}</h3>
                        <p class="text-sm text-green-500 mt-1">Registered patients</p>
                    </div>
                    <div class="p-3 bg-green-100 rounded-xl">
                        <i class="fas fa-user-injured text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="card p-6">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-slate-500">Sessions Completed</p>
                        <h3 class="text-2xl font-bold mt-2 text-slate-800">${actualStats.completedSessions || 0}</h3>
                        <p class="text-sm text-green-500 mt-1">Total sessions</p>
                    </div>
                    <div class="p-3 bg-purple-100 rounded-xl">
                        <i class="fas fa-hand-holding-heart text-purple-600 text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="card p-6">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-slate-500">Revenue</p>
                        <h3 class="text-2xl font-bold mt-2 text-slate-800">â‚¹${(actualStats.monthlyRevenue || 0).toLocaleString()}</h3>
                        <p class="text-sm text-green-500 mt-1">Current month</p>
                    </div>
                    <div class="p-3 bg-amber-100 rounded-xl">
                        <i class="fas fa-rupee-sign text-amber-600 text-xl"></i>
                    </div>
                </div>
            </div>
        `;
    }

    function updateAppointments(appointments) {
        const container = document.getElementById('appointmentsContainer');
        
        if (!appointments || appointments.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-calendar-times text-4xl text-slate-300 mb-4"></i>
                    <p class="text-slate-500 text-lg mb-4">No appointments scheduled</p>
                    <button onclick="createNewAppointment()" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition">
                        <i class="fas fa-plus mr-2"></i>Create First Appointment
                    </button>
                </div>
            `;
            return;
        }
        
        let appointmentsHTML = '';
        
        appointments.forEach(appt => {
            const date = new Date(appt.date);
            const timeString = appt.time_slot || date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            const dateString = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            const isToday = new Date().toDateString() === date.toDateString();
            
            let statusClass = 'status-scheduled';
            if (appt.status === 'completed') statusClass = 'status-completed';
            if (appt.status === 'cancelled') statusClass = 'status-cancelled';
            if (appt.status === 'pending') statusClass = 'status-pending';
            if (appt.status === 'confirmed') statusClass = 'status-scheduled';
            
            // Get patient/therapist initials from name or use default
            const displayName = appt.patient_name || appt.therapist_name || 'User';
            const displayInitials = displayName.split(' ').map(n => n[0]).join('').toUpperCase() || 'US';
            
            appointmentsHTML += `
                <div class="appointment-card card p-4 mb-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold mr-4">
                                ${displayInitials}
                            </div>
                            <div>
                                <h4 class="font-semibold text-slate-800">${displayName}</h4>
                                <p class="text-sm text-slate-600">${appt.reason || 'Therapy Session'}</p>
                                <div class="flex items-center mt-1">
                                    <i class="fas fa-clock text-slate-400 text-xs mr-1"></i>
                                    <p class="text-xs text-slate-500">${isToday ? 'Today' : dateString}, ${timeString}</p>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="status-badge ${statusClass}">${appt.status.charAt(0).toUpperCase() + appt.status.slice(1)}</span>
                            <div class="flex space-x-2 mt-2">
                                ${appt.status === 'scheduled' || appt.status === 'confirmed' ? `
                                <button class="p-2 text-slate-500 hover:text-green-500 hover:bg-green-50 rounded-lg transition" onclick="completeAppointment('${appt.appointment_id || appt._id}')">
                                    <i class="fas fa-check"></i>
                                </button>
                                ` : ''}
                                <button class="p-2 text-slate-500 hover:text-blue-500 hover:bg-blue-50 rounded-lg transition" onclick="editAppointment('${appt.appointment_id || appt._id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                ${appt.status !== 'completed' && appt.status !== 'cancelled' ? `
                                <button class="p-2 text-slate-500 hover:text-red-500 hover:bg-red-50 rounded-lg transition" onclick="cancelAppointment('${appt.appointment_id || appt._id}')">
                                    <i class="fas fa-times"></i>
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = appointmentsHTML;
    }

    function updateNotifications(notifications) {
        const notificationList = document.getElementById('notificationList');
        const recentNotifications = document.getElementById('recentNotifications');
        const notificationCount = document.getElementById('notificationCount');
        
        // Update notification badge
        const unreadCount = notifications.filter(n => !n.is_read).length;
        notificationCount.textContent = unreadCount > 0 ? unreadCount : '';
        
        // Update notification dropdown
        if (!notifications || notifications.length === 0) {
            notificationList.innerHTML = '<p class="p-4 text-slate-500 text-center">No notifications</p>';
        } else {
            notificationList.innerHTML = notifications.map(notification => `
                <div class="p-4 border-b border-slate-100 hover:bg-slate-50 cursor-pointer ${!notification.is_read ? 'bg-blue-50' : ''}" onclick="markNotificationAsRead('${notification._id || notification.id}')">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-semibold text-sm text-slate-800">${notification.title}</h4>
                            <p class="text-sm text-slate-600 mt-1">${notification.message}</p>
                            <p class="text-xs text-slate-400 mt-2">${formatTimeAgo(new Date(notification.created_at))}</p>
                        </div>
                        ${!notification.is_read ? '<span class="w-2 h-2 bg-blue-500 rounded-full ml-2 mt-1"></span>' : ''}
                    </div>
                </div>
            `).join('');
        }
        
        // Update recent notifications in sidebar
        const recent = notifications.slice(0, 3);
        if (recent.length === 0) {
            recentNotifications.innerHTML = '<p class="text-slate-500 text-center py-4">No recent notifications</p>';
        } else {
            recentNotifications.innerHTML = recent.map(notification => `
                <div class="mb-4 p-3 border border-slate-200 rounded-xl ${!notification.is_read ? 'bg-blue-50 border-blue-200' : ''}">
                    <h4 class="font-semibold text-sm text-slate-800">${notification.title}</h4>
                    <p class="text-sm text-slate-600 mt-1">${notification.message}</p>
                    <p class="text-xs text-slate-500 mt-2">${formatTimeAgo(new Date(notification.created_at))}</p>
                </div>
            `).join('');
        }
    }

    function formatTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins} minute${diffMins === 1 ? '' : 's'} ago`;
        if (diffHours < 24) return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
        return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
    }

    // Real-time updates
    function startRealTimeUpdates() {
        // Real updates will be handled by API calls
        setInterval(() => {
            loadRealStats();
            loadRealAppointments();
            loadRealNotifications();
        }, 30000); // Update every 30 seconds
    }

    // Action functions - updated to use API calls
    function createNewAppointment() {
        window.location.href = '/book-appointment';
    }

    function addNewPatient() {
        alert('This feature will open patient registration form');
        // In a real app, this would open a patient registration modal
    }

    function createReport() {
        alert('This feature will generate reports');
        // In a real app, this would open a report generation dialog
    }

    function showTodaysSchedule() {
        alert('This feature will show today\'s schedule');
        // In a real app, this would filter appointments to show only today's
    }

    function toggleFilter() {
        alert('This feature will open filter options');
        // In a real app, this would open a filter panel
    }

    function completeAppointment(id) {
        fetch(`/api/appointments/${id}/complete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                showToast('Appointment Completed', data.message);
                loadRealAppointments();
                loadRealStats();
            } else {
                showToast('Error', data.error || 'Failed to complete appointment', 'error');
            }
        })
        .catch(error => {
            console.error('Error completing appointment:', error);
            showToast('Error', 'Failed to complete appointment', 'error');
        });
    }

    function editAppointment(id) {
        alert(`This feature will edit appointment: ${id}`);
        // In a real app, this would open an edit form
    }

    function cancelAppointment(id) {
        if (confirm('Are you sure you want to cancel this appointment?')) {
            fetch(`/api/appointments/${id}/cancel`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    showToast('Appointment Cancelled', data.message);
                    loadRealAppointments();
                    loadRealStats();
                } else {
                    showToast('Error', data.error || 'Failed to cancel appointment', 'error');
                }
            })
            .catch(error => {
                console.error('Error cancelling appointment:', error);
                showToast('Error', 'Failed to cancel appointment', 'error');
            });
        }
    }

    function markNotificationAsRead(id) {
        fetch(`/api/notifications/${id}/read`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                loadRealNotifications();
            }
        })
        .catch(error => {
            console.error('Error marking notification as read:', error);
        });
    }

    function showToast(title, message, type = 'success') {
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 ${
            type === 'error' ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200'
        } border rounded-xl shadow-lg p-4 max-w-sm z-50 transform transition-transform duration-300 translate-x-full`;
        toast.innerHTML = `
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 ${
                        type === 'error' ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'
                    } rounded-full flex items-center justify-center">
                        <i class="fas ${type === 'error' ? 'fa-exclamation-triangle' : 'fa-check'}"></i>
                    </div>
                </div>
                <div class="ml-3">
                    <p class="font-semibold ${
                        type === 'error' ? 'text-red-800' : 'text-green-800'
                    }">${title}</p>
                    <p class="text-sm ${
                        type === 'error' ? 'text-red-600' : 'text-green-600'
                    } mt-1">${message}</p>
                </div>
                <button class="ml-auto ${
                    type === 'error' ? 'text-red-400 hover:text-red-600' : 'text-green-400 hover:text-green-600'
                }" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Animate in
        setTimeout(() => {
            toast.classList.remove('translate-x-full');
        }, 10);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (toast.parentElement) {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.parentElement.removeChild(toast);
                    }
                }, 300);
            }
        }, 5000);
    }
</script>
</html>