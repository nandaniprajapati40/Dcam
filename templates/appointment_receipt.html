<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appointment Receipt - DCAM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @media print {
            .no-print { display: none !important; }
            body { -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4 max-w-4xl">
        <!-- Print Button -->
        <div class="no-print mb-4 text-right">
            <button onclick="window.print()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                <i class="fas fa-print mr-2"></i>Print Receipt
            </button>
            <button onclick="window.close()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 ml-2">
                <i class="fas fa-times mr-2"></i>Close
            </button>
        </div>

        <!-- Receipt Card -->
        <div id="receiptContent" class="bg-white rounded-lg shadow-lg p-6">
            <!-- Loading -->
            <div id="loading" class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-2xl text-blue-500 mb-4"></i>
                <p>Loading receipt...</p>
            </div>

            <!-- Receipt Data -->
            <div id="receiptData" class="hidden">
                <!-- Header -->
                <div class="text-center border-b-2 border-green-500 pb-4 mb-6">
                    <h1 class="text-3xl font-bold text-green-600">DCAM Therapy Center</h1>
                    <p class="text-gray-600">Dev Sanskriti Vishwavidyalaya, Haridwar</p>
                    <p class="text-gray-600">Appointment Receipt</p>
                </div>

                <!-- Appointment Details -->
                <div class="grid grid-cols-2 gap-6 mb-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-3">Appointment Information</h3>
                        <div class="space-y-2">
                            <p><strong>Appointment ID:</strong> <span id="receiptAppointmentId" class="font-mono"></span></p>
                            <p><strong>Therapy Type:</strong> <span id="receiptTherapy"></span></p>
                            <p><strong>Consultation:</strong> <span id="receiptConsultation"></span></p>
                            <p><strong>Date:</strong> <span id="receiptDate"></span></p>
                            <p><strong>Time:</strong> <span id="receiptTime"></span></p>
                            <p><strong>Status:</strong> <span id="receiptStatus" class="font-semibold"></span></p>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-semibold mb-3">Patient Information</h3>
                        <div class="space-y-2">
                            <p><strong>Name:</strong> <span id="receiptPatientName"></span></p>
                            <p><strong>Email:</strong> <span id="receiptPatientEmail"></span></p>
                            <p><strong>Phone:</strong> <span id="receiptPatientPhone"></span></p>
                        </div>
                    </div>
                </div>

                <!-- Doctor & Payment Info -->
                <div class="grid grid-cols-2 gap-6 mb-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-3">Doctor Information</h3>
                        <div class="space-y-2">
                            <p><strong>Doctor:</strong> <span id="receiptDoctor"></span></p>
                            <p><strong>Reason:</strong> <span id="receiptReason"></span></p>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-semibold mb-3">Payment Information</h3>
                        <div class="space-y-2">
                            <p><strong>Amount:</strong> â‚¹<span id="receiptAmount">100</span></p>
                            <p><strong>Payment Status:</strong> <span id="receiptPaymentStatus" class="font-semibold"></span></p>
                            <p><strong>Payment Date:</strong> <span id="receiptPaymentDate"></span></p>
                            <p><strong>Payment ID:</strong> <span id="receiptPaymentId" class="font-mono text-sm"></span></p>
                        </div>
                    </div>
                </div>

                <!-- Notes -->
                <div class="border-t pt-4">
                    <h3 class="text-lg font-semibold mb-2">Important Notes</h3>
                    <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                        <li>Please arrive 10 minutes before your scheduled appointment time</li>
                        <li>Bring this receipt and any relevant medical reports</li>
                        <li>Cancellations must be made at least 24 hours in advance</li>
                        <li>For any queries, contact reception at reception@dsvv.ac.in</li>
                    </ul>
                </div>

                <!-- Footer -->
                <div class="border-t mt-6 pt-4 text-center text-gray-500 text-sm">
                    <p>Generated on: <span id="receiptGeneratedDate"></span></p>
                    <p>Thank you for choosing DCAM Therapy Center</p>
                </div>
            </div>

            <!-- Error State -->
            <div id="receiptError" class="hidden text-center py-8">
                <i class="fas fa-exclamation-triangle text-2xl text-red-500 mb-4"></i>
                <p class="text-red-500">Failed to load receipt data</p>
                <button onclick="loadReceiptData()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg">
                    Try Again
                </button>
            </div>
        </div>
    </div>

    <script>
        async function loadReceiptData() {
            const appointmentId = window.location.pathname.split('/').pop();
            
            try {
                const response = await fetch(`/api/appointment-receipt/${appointmentId}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Populate receipt data
                document.getElementById('receiptAppointmentId').textContent = data.appointment_id;
                document.getElementById('receiptTherapy').textContent = data.therapy_type;
                document.getElementById('receiptConsultation').textContent = data.consultation_type;
                document.getElementById('receiptDate').textContent = data.appointment_date;
                document.getElementById('receiptTime').textContent = data.appointment_time;
                document.getElementById('receiptStatus').textContent = data.status;
                document.getElementById('receiptPatientName').textContent = data.patient_name;
                document.getElementById('receiptPatientEmail').textContent = data.patient_email;
                document.getElementById('receiptPatientPhone').textContent = data.patient_phone;
                document.getElementById('receiptDoctor').textContent = data.doctor_name;
                document.getElementById('receiptReason').textContent = data.reason;
                document.getElementById('receiptAmount').textContent = data.amount;
                document.getElementById('receiptPaymentStatus').textContent = data.payment_status;
                document.getElementById('receiptPaymentDate').textContent = data.payment_date;
                document.getElementById('receiptPaymentId').textContent = data.payment_id;
                document.getElementById('receiptGeneratedDate').textContent = data.receipt_date;
                
                // Style status badges
                const statusElement = document.getElementById('receiptStatus');
                statusElement.className = 'font-semibold ' + (
                    data.status === 'completed' ? 'text-green-600' :
                    data.status === 'confirmed' ? 'text-blue-600' :
                    data.status === 'pending' ? 'text-yellow-600' :
                    'text-gray-600'
                );
                
                const paymentStatusElement = document.getElementById('receiptPaymentStatus');
                paymentStatusElement.className = 'font-semibold ' + (
                    data.payment_status === 'paid' ? 'text-green-600' :
                    'text-red-600'
                );
                
                // Show receipt data
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('receiptData').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading receipt:', error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('receiptError').classList.remove('hidden');
            }
        }

        // Load receipt data when page loads
        document.addEventListener('DOMContentLoaded', loadReceiptData);
    </script>

<!-- Add this to the script section -->
<script>
    async function loadReceiptData() {
        const appointmentId = window.location.pathname.split('/').pop();
        
        // Validate appointment ID
        if (!appointmentId || appointmentId === 'appointment-receipt') {
            showReceiptError('Invalid appointment ID');
            return;
        }
        
        try {
            const response = await fetch(`/api/appointment-receipt/${appointmentId}`);
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            populateReceiptData(data);
            
        } catch (error) {
            console.error('Error loading receipt:', error);
            showReceiptError('Failed to load receipt data: ' + error.message);
        }
    }

    function showReceiptError(message) {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('receiptError').classList.remove('hidden');
        document.getElementById('receiptError').innerHTML = `
            <i class="fas fa-exclamation-triangle text-2xl text-red-500 mb-4"></i>
            <p class="text-red-500">${message}</p>
            <button onclick="loadReceiptData()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg">
                Try Again
            </button>
            <button onclick="goToDashboard()" class="mt-2 bg-gray-600 text-white px-4 py-2 rounded-lg ml-2">
                Go to Dashboard
            </button>
        `;
    }

    function goToDashboard() {
        window.location.href = '/patient-dashboard';
    }

    // Load receipt data when page loads
    document.addEventListener('DOMContentLoaded', loadReceiptData);

    // After successful payment
if (response.success) {
    showToast(response.message, 'success');
    
    // Redirect to receipt page if available
    if (response.redirect_url) {
        setTimeout(() => {
            window.location.href = response.redirect_url;
        }, 2000);
    } else if (response.appointment_id) {
        // Fallback: redirect to receipt page with appointment ID
        setTimeout(() => {
            window.location.href = `/appointment-receipt/${response.appointment_id}`;
        }, 2000);
    }
}
</script>    
</body>
</html>